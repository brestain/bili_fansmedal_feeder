# B站粉丝勋章自动挂亲密度小助手 - 用户使用指南

## 目录

- [B站粉丝勋章自动挂亲密度小助手 - 用户使用指南](#b站粉丝勋章自动挂亲密度小助手---用户使用指南)
  - [目录](#目录)
  - [开始](#开始)
    - [Windows 使用](#windows-使用)
      - [1. 下载项目](#1-下载项目)
      - [2. 安装 Python 依赖](#2-安装-python-依赖)
      - [3. 获取 access\_key](#3-获取-access_key)
      - [4. 配置 users.yaml](#4-配置-usersyaml)
      - [5. 生成粉丝牌权重配置文件](#5-生成粉丝牌权重配置文件)
      - [6. 配置粉丝牌权重（可选）](#6-配置粉丝牌权重可选)
      - [7. 运行主程序](#7-运行主程序)
    - [Linux 使用](#linux-使用)
      - [1. 下载项目](#1-下载项目-1)
      - [2. 安装 Python 依赖](#2-安装-python-依赖-1)
      - [3. 获取 access\_key](#3-获取-access_key-1)
      - [4. 配置 users.yaml](#4-配置-usersyaml-1)
      - [5. 生成粉丝牌权重配置文件](#5-生成粉丝牌权重配置文件-1)
      - [6. 配置粉丝牌权重（可选）](#6-配置粉丝牌权重可选-1)
      - [7. 运行主程序](#7-运行主程序-1)
    - [Docker 使用](#docker-使用)
      - [1. 拉取镜像](#1-拉取镜像)
      - [2. 准备配置文件](#2-准备配置文件)
      - [3. 运行容器](#3-运行容器)
      - [4. 查看日志](#4-查看日志)
      - [5. 停止和删除容器](#5-停止和删除容器)
  - [配置参数详解](#配置参数详解)
    - [users.yaml 配置参数](#usersyaml-配置参数)
      - [配置示例](#配置示例)
    - [fansmedal\_weight.yaml 配置参数](#fansmedal_weightyaml-配置参数)
      - [配置示例](#配置示例-1)
  - [核心功能操作细节](#核心功能操作细节)
    - [功能1：获取 access\_key（登录认证）](#功能1获取-access_key登录认证)
    - [功能2：生成粉丝牌权重配置文件](#功能2生成粉丝牌权重配置文件)
    - [功能3：配置黑名单和白名单](#功能3配置黑名单和白名单)
    - [功能4：配置直播间权重](#功能4配置直播间权重)
    - [功能5：运行主程序（自动观看直播）](#功能5运行主程序自动观看直播)
  - [常见问题排查](#常见问题排查)
    - [错误1：读取配置文件失败](#错误1读取配置文件失败)
    - [错误2：登录失败，access\_key 过期](#错误2登录失败access_key-过期)
    - [错误3：心跳失败或观看时长不累计](#错误3心跳失败或观看时长不累计)
    - [错误4：Docker 容器无法读取配置文件](#错误4docker-容器无法读取配置文件)
    - [获取详细日志用于问题反馈](#获取详细日志用于问题反馈)
  - [注意事项](#注意事项)
  - [更新日志](#更新日志)
  - [技术支持](#技术支持)

---

## 开始

### Windows 使用

#### 1. 下载项目

```powershell
# 使用 Git 克隆项目（推荐）
git clone https://github.com/brestain/bili_fansmedal_feeder.git

cd bili_fansmedal_feeder
--------------------------------------
# 或者直接下载 ZIP 压缩包并解压
```

#### 2. 安装 Python 依赖

```powershell
# 确保已安装 Python 3.12.8
python --version

# 安装依赖
pip install -r requirements.txt
```

> 如果使用 `pip` 命令失败，可以尝试使用 `pip3` 或 `python -m pip`。

#### 3. 获取 access_key

> 📚 **详细操作指南**：详细介绍请查看 [获取 access_key（登录认证）](#功能1获取-access_key登录认证)

```powershell
# 运行登录工具
python logintool\login.py
```

**操作步骤**：
1. 运行命令后，终端会显示一个二维码
2. 使用 B站手机客户端扫描二维码
3. 在手机上确认登录
4. 登录成功后，`access_key` 会保存在 `access_key.txt` 文件中

> 获取的access_key有效期好像是半年.

#### 4. 配置 users.yaml

> 📚 **详细配置说明**：详细介绍请查看 [配置参数详解](#配置参数详解)

```powershell
# 复制示例配置文件
copy users.yaml.example users.yaml
```

将 `access_key.txt` 中的内容复制到 `users.yaml` 的 `access_key` 字段：

```yaml
USERS:
    - access_key: 你的access_key粘贴到这里
      white_uid: 0  # 白名单用户ID，多个用英文逗号分隔，不用就填0
      banned_uid: 0  # 黑名单UID，多个用英文逗号分隔，不用就填0
```

> **重要提示**：
> - 冒号后面必须有空格（`access_key: ` 而不是 `access_key:`）
> - 使用英文冒号和英文逗号
> - 注释符号 `#` 前后必须有空格

#### 5. 生成粉丝牌权重配置文件

```powershell
# 运行权重生成脚本
python generate_fansmedal_weight.py
```

脚本会自动：
- 读取 `users.yaml` 中的所有账号信息
- 为每个账号获取粉丝牌列表
- 为每个账号生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
- 如果文件已存在，会更新新增的粉丝牌（保留自定义权重）

#### 6. 配置粉丝牌权重（可选）

> 📚 **详细配置说明**：详细介绍请查看 [配置参数详解](#配置参数详解)

**权重文件读取优先级**：
1. `fansmedal_weight_{用户ID}.yaml` - 用户特定的权重文件（优先使用）
2. `fansmedal_weight.yaml` - 通用权重文件（可选账号很多懒得一个个配置时用）
3. 默认权重 100 - 如果以上文件都不存在或未配置


```yaml
'123456':
  medal_name: 粉丝牌名
  up_name: up名
  weight: 100
```

**多账号用户**：
- 每个账号有独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
- 可以为每个账号单独配置权重
- 如果多个账号需要共享权重配置，可以配置通用的 `fansmedal_weight.yaml`

> **权重说明**：权重越大，该直播间越优先被观看。相同权重时，粉丝牌等级越高越优先。

#### 7. 运行主程序

```powershell
# 运行主程序（会一直循环执行）
python main.py
```

程序会：
- 自动检测正在开播的直播间
- 优先观看权重高的直播间
- 每个直播间观看 5 分钟，获得 6 亲密度
- 每日最多获得 30 亲密度（需要观看 25 分钟）
- 每 5 分钟重新检测一次直播间状态

> **提示**：程序会持续运行，按 `Ctrl+C` 可以停止。

---

### Linux 使用

#### 1. 下载项目

```bash
# 使用 Git 克隆项目（推荐）
git clone https://github.com/brestain/bili_fansmedal_feeder.git

cd bili_fansmedal_feeder
-----------------------------------------------
# 或者使用 wget 下载 ZIP 压缩包
wget https://github.com/brestain/bili_fansmedal_feeder/archive/refs/heads/master.zip

unzip master.zip

cd bili_fansmedal_feeder-master
```

#### 2. 安装 Python 依赖

```bash
# 确保已安装 Python 3.8 或更高版本
python3 --version

# 安装依赖
pip3 install -r requirements.txt

# 如果提示权限不足，使用 --user 参数
pip3 install --user -r requirements.txt
```

#### 3. 获取 access_key

> 📚 **详细操作指南**：详细介绍请查看 [获取 access_key（登录认证）](#功能1获取-access_key登录认证)

```bash
# 运行登录工具
python3 logintool/login.py
```

**操作步骤**：
1. 运行命令后，终端会显示一个二维码
2. 使用 B站手机客户端扫描二维码
3. 在手机上确认登录
4. 登录成功后，`access_key` 会保存在 `access_key.txt` 文件中

#### 4. 配置 users.yaml

> 📚 **详细配置说明**：详细介绍请查看 [配置参数详解](#配置参数详解)

```bash
# 复制示例配置文件
cp users.yaml.example users.yaml

# 使用文本编辑器打开 users.yaml
nano users.yaml
# 或使用 vim
vim users.yaml
```

将 `access_key.txt` 中的内容复制到 `users.yaml` 的 `access_key` 字段：

```yaml
USERS:
    - access_key: 你的access_key粘贴到这里
      white_uid: 0  # 白名单用户ID，多个用英文逗号分隔，不用就填0
      banned_uid: 0  # 黑名单UID，多个用英文逗号分隔，不用就填0
```

#### 5. 生成粉丝牌权重配置文件

```bash
# 运行权重生成脚本
python3 generate_fansmedal_weight.py
```

#### 6. 配置粉丝牌权重（可选）

> 📚 **详细配置说明**：详细介绍查看 [配置参数详解](#配置参数详解)

**权重文件读取优先级**：
1. `fansmedal_weight_{用户ID}.yaml` - 用户特定的权重文件（优先使用）
2. `fansmedal_weight.yaml` - 通用权重文件（备用）
3. 默认权重 100 - 如果以上文件都不存在

```bash
# 编辑用户特定的权重配置文件（推荐）
nano fansmedal_weight_12345678.yaml  # 数字为你的uid

# 或编辑通用权重配置文件
nano fansmedal_weight.yaml
```

修改权重值（格式同 Windows 部分）。

#### 7. 运行主程序

```bash
# 直接运行（前台运行）
python3 main.py
--------------------------------------------
# 或使用 nohup 后台运行
nohup python3 main.py > log.txt 2>&1 &
--------------------------------------------
# 或使用 screen（推荐）
screen -S bili_feeder
python3 main.py
# 按 Ctrl+A 然后按 D 退出 screen，使用 screen -r bili_feeder 重新连接
```

**查看日志**：

根据不同的运行方式，查看日志的方法也不同：

1. **前台运行**：
   - 日志直接输出到终端，可以直接查看
   - 按 `Ctrl+C` 停止程序

2. **nohup 后台运行**：
   ```bash
   # 实时查看日志（类似 tail -f）
   tail -f log.txt
   
   # 查看最近 100 行日志
   tail -n 100 log.txt
   
   # 查看全部日志
   cat log.txt
   ```

3. **screen 运行**：
   ```bash
   # 重新连接到 screen 会话查看日志
   screen -r bili_feeder
   
   # 如果需要将日志保存到文件，可以在 screen 中运行：
   screen -S bili_feeder
   python3 main.py | tee log.txt
   # 这样既能在终端看到日志，又能保存到文件
   ```

---

### Docker 使用

#### 1. 拉取镜像

```bash
# 如果项目已发布到 Docker Hub
docker pull brestain/bili_fansmedal_feeder:latest
```

#### 2. 准备配置文件

> 📚 **详细配置说明**：详细介绍请查看 [配置参数详解](#配置参数详解)

在本地创建 `users.yaml` 和 `fansmedal_weight.yaml`（参考 Windows/Linux 部分的配置方法）。

#### 3. 运行容器

```bash
# 方式1：使用挂载卷（推荐）
docker run -d \
  --name bili_feeder \
  -v $(pwd)/users.yaml:/app/bili_fansmedal_feeder/users.yaml \
  -v $(pwd)/fansmedal_weight.yaml:/app/bili_fansmedal_feeder/fansmedal_weight.yaml \
  brestain/bili_fansmedal_feeder:latest

# 方式2：使用环境变量（需要将 users.yaml 转换为 JSON）
# 先获取 access_key（在本地运行 login.py）
# 然后构建 JSON 格式的环境变量
docker run -d \
  --name bili_feeder \
  -e USERS='{"USERS":[{"access_key":"你的access_key","white_uid":"0","banned_uid":"0"}]}' \
  brestain/bili_fansmedal_feeder:latest
```

#### 4. 查看日志

```bash
# 查看容器日志
docker logs -f bili_feeder

# 查看最近 100 行日志
docker logs --tail 100 bili_feeder
```

#### 5. 停止和删除容器

```bash
# 停止容器
docker stop bili_feeder

# 删除容器
docker rm bili_feeder
```

---

## 配置参数详解

### users.yaml 配置参数

| 参数名 | 数据类型 | 默认值 | 必填 | 详细说明与作用 |
|--------|---------|--------|------|----------------|
| `USERS` | 数组 | - | 是 | 用户账号列表，支持多个账号 |
| `USERS[].access_key` | 字符串 | - | 是 | B站登录凭证，通过 `logintool/login.py` 获取 |
| `USERS[].white_uid` | 字符串 | `0` | 否 | 白名单用户ID，多个用英文逗号分隔。填写后只会打卡这些用户。不填或填 `0` 则不限制 |
| `USERS[].banned_uid` | 字符串 | `0` | 否 | 黑名单UID，多个用英文逗号分隔。填了后将不会打卡、点赞、分享。不填或填 `0` 则不限制 |
| `WATCHINGLIVE` | 整数 | `25` | 否 | 每日每直播间观看时长（单位：分钟）。默认 `25` 分钟。一般不用动 |
| `VERBOSE_LOG` | 整数 | `0` | 否 | 日志详细程度，`0` 只打印关键信息，`1` 打印详细日志（包括调试信息，反馈问题时将此项设为1连同日志提交。 |


<!-- | `ASYNC` | 整数 | `0` | 否 | 异步执行模式，`0` 表示同步执行（默认），`1` 表示异步执行 | -->
#### 配置示例

**单用户配置**：

```yaml
USERS:
    - access_key: xxxxxxxxxxxxxx
      white_uid: 0
      banned_uid: 0

VERBOSE_LOG: 0
WATCHINGLIVE: 25
```

**多用户配置**：

```yaml
USERS:
    - access_key: 第一个账号的access_key
      white_uid: 0
      banned_uid: 123456,789012  # 黑名单：不打卡这两个用户

    - access_key: 第二个账号的access_key
      white_uid: 111111,222222  # 白名单：只打卡这两个用户
      banned_uid: 0

VERBOSE_LOG: 1
WATCHINGLIVE: 25
```

> **多账号说明**：
> - 支持在 `USERS` 数组中配置多个账号
> - 每个账号独立运行，互不影响
> - 每个账号会生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
> - 每个账号的日志会保存到独立的文件：`{用户ID}.log`
> - 所有账号会并发执行，提高效率


### fansmedal_weight.yaml 配置参数

**权重文件读取优先级**（按顺序）：
1. `fansmedal_weight_{用户ID}.yaml` - 用户特定的权重文件（优先使用）
2. `fansmedal_weight.yaml` - 通用权重文件（备用，如果用户特定文件不存在）
3. 默认权重 100 - 如果以上文件都不存在或未配置

| 参数名 | 数据类型 | 默认值 | 必填 | 详细说明与作用 |
|--------|---------|--------|------|----------------|
| `用户ID` | 字符串（作为键） | - | 是 | 主播的用户ID（target_id），从 `generate_fansmedal_weight.py` 自动获取 |
| `up_name` | 字符串 | - | 是 | 主播昵称，自动同步 |
| `medal_name` | 字符串 | - | 是 | 粉丝牌名称，自动同步 |
| `weight` | 整数 | `100` | 否 | 权重值，越大越优先。相同权重时，粉丝牌等级越高越优先 |

> **多账号权重配置说明**：
> - 每个账号会生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
> - 程序会优先读取用户特定的权重文件
> - 如果用户特定文件不存在，会读取通用的 `fansmedal_weight.yaml`
> - 如果都不存在，使用默认权重 100
> - 这样可以为每个账号单独配置权重，也可以多个账号共享通用配置

#### 配置示例

```yaml
'111111':  # 用户ID（字符串格式）
  medal_name: 粉丝牌名1
  up_name: up名1
  weight: 10000  # 高权重，优先观看

'22222':
  medal_name: 粉丝牌名2
  up_name: up名2
  weight: 100  # 默认权重，正常观看

'333333':
  medal_name: 粉丝牌名3
  up_name: up名3
  weight: 10  # 低权重，优先观看别的直播间

```

> **权重优先级说明**：
> - 权重值越大，该直播间越优先被观看
> - 相同权重时，粉丝牌等级越高越优先
> - **△建议给直播时间较短或你特别关注的up设置更高的权重**
---

## 核心功能操作细节

### 功能1：获取 access_key（登录认证）

**应用场景**：首次使用或 `access_key` 过期时需要重新获取。

**操作步骤**：

1. **Windows**：
   ```powershell
   cd logintool
   python login.py
   ```

2. **Linux**：
   ```bash
   cd logintool
   python3 login.py
   ```

3. **等待二维码显示**：
   - 终端会显示一个二维码
   - 如果二维码显示不完整，请最大化终端窗口

4. **扫码登录**：
   - 打开 B站手机客户端
   - 扫描终端中的二维码
   - 在手机上点击"确认登录"

5. **获取 access_key**：
   - 登录成功后，终端会显示 `access_key`
   - `access_key` 也会保存在 `access_key.txt`(在运行脚本的目录下) 文件中

**输入示例**：

无需输入，按提示操作即可。

**预期输出**：

```
✅ 登录成功！
access_key: 49b4148f7444444c44444f444...
access_key 已保存到 access_key.txt
```

---

### 功能2：生成粉丝牌权重配置文件

**应用场景**：首次使用或新增粉丝牌后，需要生成或更新权重配置文件。
(不更新或者不配置此文件也会正常去打卡, 只是权重默认使用100)

**权重文件说明**：
- 脚本会为每个账号生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
- 程序会优先读取用户特定的权重文件
- 如果用户特定文件不存在，会读取通用的 `fansmedal_weight.yaml`
- 如果都不存在，使用默认权重 100

**操作步骤**：

1. **确保已配置 users.yaml**：
   - `users.yaml` 中必须已填写正确的 `access_key`（支持多账号）

2. **运行生成脚本**：
   ```powershell
   # Windows
   python generate_fansmedal_weight.py
   
   # Linux
   python3 generate_fansmedal_weight.py
   ```

3. **等待脚本执行**：
   - 脚本会自动读取 `users.yaml` 中的所有账号
   - 为每个账号获取粉丝牌列表
   - 为每个账号生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`

4. **查看生成结果**：
   - 脚本会显示每个账号的处理结果
   - 显示生成/更新的粉丝牌数量
   - 按任意键退出

**输入示例**：

无需输入，脚本会自动读取配置文件。

**预期输出**（多账号示例）：

```
============================================================
开始处理各账号的粉丝牌权重文件
============================================================

[1/2] 处理账号【用户名1】(ID: 12345678)
  ✅ 已生成新文件: fansmedal_weight_12345678.yaml
  共记录 37 个粉丝牌（默认权重为 100）
    - 新增 37 个粉丝牌

[2/2] 处理账号【用户名2】(ID: 87654321)
  ✅ 已更新文件: fansmedal_weight_87654321.yaml
  共记录 25 个粉丝牌
    - 新增 2 个粉丝牌
    - 更新 1 个粉丝牌的名称信息

============================================================
任务完成
============================================================
共处理 2 个账号

按任意键结束...
```

---

### 功能3：配置黑名单和白名单

**应用场景**：需要限制只打卡某些直播间，或排除某些直播间。

**操作步骤**：

1. **打开 users.yaml**：
   ```powershell
   # Windows
   notepad users.yaml
   
   # Linux
   nano users.yaml
   ```

2. **配置白名单**（只打卡指定用户）：
   ```yaml
   USERS:
       - access_key: 你的access_key
         white_uid: 1234567,1234576,1237456  # 只打卡这三个用户
         banned_uid: 0
   ```

3. **配置黑名单**（排除指定用户）：
   ```yaml
   USERS:
       - access_key: 你的access_key
         white_uid: 0
         banned_uid: 123456,1234567  # 不打卡这两个用户
   ```

> **多账号配置**：每个账号可以独立配置白名单和黑名单，互不影响。

4. **保存文件**：
   - Windows：按 `Ctrl+S` 保存
   - Linux：按 `Ctrl+O` 保存，然后按 `Ctrl+X` 退出

**输入示例**：

```yaml
# 白名单示例：只打卡三个用户
white_uid: 1234567,1234576,1237456

# 黑名单示例：排除两个用户
banned_uid: 123456,1234567

# 不限制：两个都填0
white_uid: 0
banned_uid: 0
```

**预期输出**：

程序运行时会根据配置过滤直播间：
- 白名单模式：只处理白名单中的直播间
- 黑名单模式：排除黑名单中的直播间
- 无限制模式：处理所有直播间

---

### 功能4：配置直播间权重

**应用场景**：需要优先观看某些直播间（例如直播时间较短的直播间）。

**权重文件读取优先级**：
1. `fansmedal_weight_{用户ID}.yaml` - 用户特定的权重文件（优先使用）
2. `fansmedal_weight.yaml` - 通用权重文件（备用）
3. 默认权重 100 - 如果以上文件都不存在

**操作步骤**：

1. **打开权重文件**：
   - **单账号用户**：打开 `fansmedal_weight_{你的用户ID}.yaml`
   - **多账号用户**：为每个账号打开对应的 `fansmedal_weight_{用户ID}.yaml`
   - **共享配置**：打开通用的 `fansmedal_weight.yaml`（当用户特定文件不存在时使用）
   
   ```powershell
   # Windows
   notepad fansmedal_weight_12345678.yaml  # 替换为你的用户ID
   
   # Linux
   nano fansmedal_weight_12345678.yaml  # 替换为你的用户ID
   ```

2. **修改权重值**：
   ```yaml
   '123456':  # 主播用户ID
     medal_name: 粉丝牌名
     up_name: up名
     weight: 10000  # 修改为高权重
   ```

3. **保存文件**：
   - Windows：按 `Ctrl+S` 保存
   - Linux：按 `Ctrl+O` 保存，然后按 `Ctrl+X` 退出

> **多账号权重配置**：
> - 每个账号有独立的权重文件，可以为每个账号单独配置
> - 如果多个账号需要共享权重配置，可以配置通用的 `fansmedal_weight.yaml`
> - 程序会优先读取用户特定的权重文件

**输入示例**：

```yaml
'111111':  # 用户ID（字符串格式）
  medal_name: 粉丝牌名1
  up_name: up名1
  weight: 10000  # 高权重，优先观看

'22222':
  medal_name: 粉丝牌名2
  up_name: up名2
  weight: 100  # 默认权重，正常观看

'333333':
  medal_name: 粉丝牌名3
  up_name: up名3
  weight: 10  # 低权重，优先观看别的直播间

```

**预期输出**：

程序运行时会按权重从高到低观看直播间：
- 权重高的直播间会优先观看
- 相同权重时，粉丝牌等级高的优先

---

### 功能5：运行主程序（自动观看直播）

**应用场景**：配置完成后，启动自动观看直播功能。

**操作步骤**：

1. **确保配置已完成**：
   - `users.yaml` 已配置 `access_key`
   - 生成和配置`fansmedal_weight.yaml`（可选）

2. **运行主程序**：
   ```powershell
   # Windows（前台运行）
   python main.py
   
   # Linux（前台运行）
   python3 main.py
   
   # Linux（后台运行，推荐）
   nohup python3 main.py > log.txt 2>&1 &
   ```

3. **观察运行日志**：
   - 每个账号会显示正在观看的直播间
   - 显示每个直播间的观看进度
   - 显示亲密度变化
   - 每个账号的日志会保存到独立的文件：`{用户ID}.log`

4. **停止程序**：
   - 前台运行：按 `Ctrl+C`
   - 后台运行：使用 `kill` 命令或 `docker stop`

> **多账号运行说明**：
> - 所有账号会并发执行，互不影响
> - 每个账号独立获取粉丝牌列表和执行观看任务
> - 每个账号有独立的日志文件：`{用户ID}.log`
> - 控制台会显示所有账号的日志，但会标注用户名区分
 
**输入示例**：

无需输入，程序会自动运行。

**预期输出**（单账号）：

```
2025-01-09 20:38:23 🎖️ B站粉丝勋章自动挂亲密度小助手 启动守护模式，任务将持续运行。
2025-01-09 20:38:23 你的用户名 123456789 登录成功
2025-01-09 20:38:24 你的用户名 开始获取粉丝牌列表...
2025-01-09 20:38:25 你的用户名 共找到 3 个正在开播且亲密度<30的直播间:
2025-01-09 20:38:25 你的用户名   1. xxx (权重10000, 等级20, 亲密度0)
2025-01-09 20:38:25 你的用户名 开始观看 xxx（等级20，当前亲密度0）
2025-01-09 20:38:26 你的用户名 xxx 已进入直播间
2025-01-09 20:38:28 你的用户名 xxx 本周期已观看 0分钟0秒
2025-01-09 20:38:58 你的用户名 xxx 本周期已观看 0分钟30秒
...
2025-01-09 20:43:58 你的用户名 xxx本周期已观看 5分钟0秒
2026-01-12 22:44:24  你的用户名  xxx 本周期观看完成（实际时长：5分钟3秒），等待5秒后重新获取接口信息...
2026-01-12 22:44:29  你的用户名  xxx 本日亲密度变化: 0 -> 6 (增加了 6)
2026-01-12 22:44:29  你的用户名  xxx 5分钟周期结束，重新筛选直播间
2026-01-12 22:44:29  你的用户名  5分钟周期结束，重新请求接口并筛选直播间
...

```

---

## 常见问题排查

### 错误1：读取配置文件失败

**错误现象/报错信息**：

```
读取配置文件失败,请检查配置文件格式是否正确: ...
```

**可能原因**：

1. YAML 格式错误（冒号后缺少空格、使用了中文标点等）
2. 文件编码不是 UTF-8
3. 文件路径错误

**解决方案**：

1. **检查 YAML 格式**：
   - 确保冒号后面有空格：`access_key: `（不是 `access_key:`）
   - 使用英文冒号和英文逗号
   - 注释符号 `#` 前后必须有空格

2. **检查文件编码**：
   - 确保 `users.yaml` 使用 UTF-8 编码保存
   - Windows 用户：使用记事本保存时选择"UTF-8"编码

3. **检查文件路径**：
   - 确保 `users.yaml` 在项目根目录
   - 确保运行 `main.py` 时的工作目录是项目根目录

4. **启用详细日志**：
   ```yaml
   VERBOSE_LOG: 1  # 设置为1查看详细错误信息
   ```

---

### 错误2：登录失败，access_key 过期

**错误现象/报错信息**：

```
登录失败 可能是 access_key 过期 , 请重新获取
```

**可能原因**：

1. `access_key` 已过期（通常有效期 30 天）
2. `access_key` 格式错误
3. 账号被限制登录

**解决方案**：

1. **重新获取 access_key**：
   ```powershell
   # Windows
   python logintool\login.py
   
   # Linux
   python3 logintool/login.py
   ```

2. **更新 users.yaml**：
   - 将新的 `access_key` 复制到 `users.yaml`
   - 确保格式正确（冒号后有空格）

3. **检查账号状态**：
   - 确认账号可以正常登录 B站
   - 确认账号没有被限制

---




### 错误3：心跳失败或观看时长不累计

**错误现象/报错信息**：

```
心跳#X 失败: ...
```


**可能原因**：

1. 网络不稳定导致请求失败
2. 直播间已下播
3. 粉丝牌未点亮
4. B站 API 限制

**解决方案**：

1. **检查网络连接**：
   - 确保网络稳定
   - 如果使用代理，检查代理配置

2. **启用详细日志**：
   ```yaml
   VERBOSE_LOG: 1
   ```
   查看详细的心跳和亲密度变化信息。

---

### 错误4：Docker 容器无法读取配置文件

**错误现象/报错信息**：

```
读取配置文件失败
```

或容器日志显示配置文件不存在。

**可能原因**：

1. 配置文件路径挂载错误
2. 文件权限问题
3. 文件编码问题

**解决方案**：

1. **检查挂载路径**：
   ```bash
   # 确保使用绝对路径或正确的相对路径
   docker run -d \
     --name bili_feeder \
     -v /绝对路径/users.yaml:/app/bili_fansmedal_feeder/users.yaml \
     brestain/bili_fansmedal_feeder:latest
   ```

2. **检查文件权限**：
   ```bash
   # Linux 下确保文件可读
   chmod 644 users.yaml
   ```

3. **使用环境变量方式**（推荐）：
   ```bash
   # 将 users.yaml 转换为 JSON 格式
   docker run -d \
     --name bili_feeder \
     -e USERS='{"USERS":[{"access_key":"你的access_key","white_uid":"0","banned_uid":"0"}]}' \
     brestain/bili_fansmedal_feeder:latest
   ```

---

### 获取详细日志用于问题反馈

如果遇到无法解决的问题，请按以下步骤获取详细日志：

1. **启用详细日志**：
   在 `users.yaml` 中设置：
   ```yaml
   VERBOSE_LOG: 1  # 设置为1
   ```

2. **重新运行程序**：
   ```powershell
   # Windows
   python main.py > log.txt 2>&1
   
   # Linux
   python3 main.py > log.txt 2>&1
   ```

3. **复制日志内容**：
   - 运行一段时间后（至少包含一次完整的观看周期）
   - 停止程序（`Ctrl+C`）
   - 打开 `log.txt`，复制相关错误信息

4. **提交问题**：
   - 在 GitHub 上创建 Issue
   - 附上 `users.yaml`（隐藏 `access_key` 的敏感部分）
   - 附上 `log.txt` 中的错误日志
   - 描述问题的具体现象和复现步骤

---

## 注意事项

1. **配置文件格式**：
   - YAML 文件对格式要求严格，冒号后必须有空格
   - 使用英文标点符号（冒号、逗号）
   - 注释符号 `#` 前后必须有空格

2. **access_key 安全**：
   - `access_key` 是敏感信息，不要泄露给他人
   - 不要将 `users.yaml` 提交到公开仓库
   - `access_key` 接口获取到的access_key有效期半年，过期后需要重新获取

3. **观看时长限制**：
   - 每个直播间每日最多获得 30 亲密度（需要观看 25 分钟）
   - 每个粉丝牌刷满需要 25 分钟
   - 理论上一天最多刷满 57 个勋章，但实际受直播时间限制

4. **优先级规则**：
   - 权重越大越优先
   - 相同权重时，粉丝牌等级越高越优先
   - 建议给直播时间较短的直播间设置更高权重

5. **权重文件读取优先级**：
   - 优先读取 `fansmedal_weight_{用户ID}.yaml`（用户特定的权重文件）
   - 如果不存在，读取 `fansmedal_weight.yaml`（通用权重文件）
   - 如果都不存在，使用默认权重 100
   - 每个账号可以独立配置权重，也可以共享通用配置

6. **多账号支持**：
   - 支持在 `users.yaml` 中配置多个账号，每个账号独立运行
   - 每个账号会生成独立的权重文件：`fansmedal_weight_{用户ID}.yaml`
   - 每个账号的日志会保存到独立的文件：`{用户ID}.log`
   - 所有账号会并发执行，互不影响

7. **程序运行方式**：
   - 程序会一直循环运行，每 5 分钟重新检测一次
   - 建议使用 `screen`、`tmux` 或 `nohup` 在后台运行
   - Docker 用户可以直接使用 `docker run -d` 后台运行

---

## 更新日志

查看项目的更新日志和版本信息，请访问 GitHub 仓库。

---

## 技术支持

如果遇到问题，请：

1. 查看本文档的"常见问题排查"部分
2. 启用详细日志（`VERBOSE_LOG: 1`）并查看日志
3. 在 GitHub 上提交 Issue，附上详细日志和配置信息（隐藏敏感信息）

---

**祝使用愉快！** 🎉

